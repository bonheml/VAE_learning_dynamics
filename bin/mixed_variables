#!/usr/bin/env python
import logging
import hydra
import numpy as np
from hydra.utils import instantiate
from omegaconf import OmegaConf
from glob import glob
from vae_ld.data.util import natural_sort
import tensorflow as tf

from vae_ld.visualisation.gmm import plot_hist, latent_traversal

logger = logging.getLogger("mixed_variables")


def get_data(sampler, encoder, n_items, batch_size):
    Z = None
    V = None
    for i in range(n_items // batch_size):
        X_tmp = sampler[i][0]
        X_tmp = encoder(X_tmp)[-2:]
        V_tmp, Z_tmp = X_tmp[0].numpy(), X_tmp[1].numpy()
        V, Z = (V_tmp, Z_tmp) if i == 0 else (np.vstack((V, V_tmp)), np.vstack((Z, Z_tmp)))
    return np.exp(V), Z


@hydra.main(config_path="config", config_name="mixed_variables")
def evaluate_on_downstream_tasks(cfg):
    logger.info("Experiment config:\n{}".format(OmegaConf.to_yaml(cfg)))
    logger.info("Retrieving the data...")
    # We create a partial instantiation first to share the same dataset between samplers
    sampler = instantiate(cfg.sampling)

    logger.info("Loading model from {}".format(cfg.model_path))
    file = sorted(glob(cfg.model_path), key=natural_sort)[-1]
    model = tf.keras.models.load_model(file)
    encoder = model.encoder
    encoder.trainable = False
    decoder = model.decoder
    decoder.trainable = False
    greyscale = cfg.dataset.observation_shape[-1] == 1

    logger.info("Instantiating the GMM")
    gmm = instantiate(cfg.classifier)

    logger.info("Sampling the data")
    Var, Z = get_data(sampler, encoder, cfg.num_train, cfg.batch_size)
    range_p = (1 - cfg.threshold, 1 + cfg.threshold)
    range_a = 0 + cfg.threshold

    for i in cfg.var_idx:
        Var_i = Var[:, i].reshape(-1, 1)
        logger.info("Training the GMM")
        _ = gmm.fit(Var_i)
        logger.info("Means: {}, Covariances: {}".format(gmm.means_, gmm.covariances_))
        plot_hist(Var_i, gmm, "{}_latent_{}_histogram.pdf".format(cfg.fname, i))
        Var_i = Var[:, i]
        Z_p = Z[np.where((Var_i >= range_p[0]) & (Var_i <= range_p[1]))][:cfg.n_samples]
        Z_a = Z[np.where(Var_i <= range_a)][:cfg.n_samples]

        if len(Z_a) > 0:
            latent_traversal(decoder, "{}_latent_{}_traversal_active.pdf".format(cfg.fname, i), Z_a,
                             greyscale, i, val_range=(Z[:, i].min(), Z[:, i].max()), n_changes=cfg.n_samples)
        if len(Z_p) > 0:
            latent_traversal(decoder, "{}_latent_{}_traversal_passive.pdf".format(cfg.fname, i), Z_p,
                             greyscale, i, val_range=(Z[:, i].min(), Z[:, i].max()), n_changes=cfg.n_samples)


if __name__ == "__main__":
    evaluate_on_downstream_tasks()
